# æŒ‰æœˆå¥—é¤ç³»ç»Ÿ - å®æ–½æ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### åç«¯éƒ¨åˆ†

1. **æ•°æ®åº“è¿ç§»** âœ…
   - æ–‡ä»¶ï¼š`bin/migration_add_subscriptions.sql`
   - åˆ›å»ºäº† subscriptionsã€user_subscriptionsã€subscription_logs ä¸‰å¼ è¡¨
   - æ‰©å±•äº† redemptions è¡¨ä»¥æ”¯æŒè®¢é˜…å¥—é¤ç 

2. **Model å±‚** âœ…
   - æ–‡ä»¶ï¼š`model/subscription.go`
   - å®ç°äº† Subscriptionã€UserSubscriptionã€SubscriptionLog ä¸‰ä¸ªæ¨¡å‹
   - åŒ…å«å®Œæ•´çš„ CRUD æ–¹æ³•ã€é¢åº¦æ¶ˆè´¹é€»è¾‘ã€Redis ç¼“å­˜åŠŸèƒ½

3. **Service å±‚** âœ…
   - æ–‡ä»¶ï¼š`service/subscription_quota.go`
   - å®ç°äº† TryConsumeSubscriptionQuota å‡½æ•°

4. **å…‘æ¢ç ç³»ç»Ÿé›†æˆ** âœ…
   - æ–‡ä»¶ï¼š`model/redemption.go`
   - æ‰©å±•äº† Redemption ç»“æ„ä½“ï¼Œæ”¯æŒè®¢é˜…å¥—é¤ç 
   - ä¿®æ”¹äº† Redeem å‡½æ•°ï¼Œæ”¯æŒå…‘æ¢è®¢é˜…å¥—é¤

5. **é…é¢æ¶ˆè´¹é€»è¾‘** âœ…
   - æ–‡ä»¶ï¼š`service/quota.go`
   - åœ¨ PostConsumeQuota å‡½æ•°ä¸­æ·»åŠ äº†è®¢é˜…é¢åº¦ä¼˜å…ˆé€»è¾‘

6. **Controller å±‚** âœ…
   - æ–‡ä»¶ï¼š`controller/subscription.go`
   - å®ç°äº†ç®¡ç†å‘˜å’Œç”¨æˆ·çš„æ‰€æœ‰ API æ¥å£

---

## ğŸ”§ å¾…å®Œæˆçš„åç«¯æ­¥éª¤

### 1. æ·»åŠ å¸¸é‡å®šä¹‰

åœ¨ `common/constants.go` ä¸­æ·»åŠ ï¼š

```go
const (
    // å…‘æ¢ç ç±»å‹
    RedemptionTypeQuota        = 1 // æ™®é€šå……å€¼ç 
    RedemptionTypeSubscription = 2 // è®¢é˜…å¥—é¤ç 
)
```

### 2. æ³¨å†Œ API è·¯ç”±

åœ¨ `router/api-router.go` ä¸­æ·»åŠ è·¯ç”±ï¼š

```go
// ç®¡ç†å‘˜è·¯ç”±ï¼ˆåœ¨ç°æœ‰ adminRouter ç»„ä¸­æ·»åŠ ï¼‰
adminRouter.GET("/subscriptions", controller.GetAllSubscriptions)
adminRouter.GET("/subscriptions/:id", controller.GetSubscription)
adminRouter.POST("/subscriptions", controller.AddSubscription)
adminRouter.PUT("/subscriptions/:id", controller.UpdateSubscription)
adminRouter.DELETE("/subscriptions/:id", controller.DeleteSubscription)
adminRouter.POST("/subscription-redemptions", controller.AddSubscriptionRedemption)

// ç”¨æˆ·è·¯ç”±ï¼ˆåœ¨ç°æœ‰ userRouter ç»„ä¸­æ·»åŠ ï¼‰
userRouter.GET("/subscriptions", controller.GetMySubscriptions)
userRouter.GET("/subscriptions/:id/quota", controller.GetMySubscriptionQuota)
userRouter.GET("/subscription-logs", controller.GetMySubscriptionLogs)
```

### 3. æ·»åŠ æ•°æ®åº“è¡¨åˆå§‹åŒ–

åœ¨ `model/main.go` çš„ `InitDB()` å‡½æ•°ä¸­æ·»åŠ ï¼š

```go
DB.AutoMigrate(&Subscription{})
DB.AutoMigrate(&UserSubscription{})
DB.AutoMigrate(&SubscriptionLog{})
```

### 4. æ·»åŠ å®šæ—¶ä»»åŠ¡

åœ¨ `main.go` ä¸­æ·»åŠ è®¢é˜…è¿‡æœŸæ£€æŸ¥ä»»åŠ¡ï¼ˆåœ¨å…¶ä»– goroutine å¯åŠ¨çš„åœ°æ–¹æ·»åŠ ï¼‰ï¼š

```go
// è®¢é˜…è¿‡æœŸæ£€æŸ¥
go func() {
    for {
        time.Sleep(time.Hour) // æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
        err := model.ExpireSubscriptions()
        if err != nil {
            common.SysLog("expire subscriptions failed: " + err.Error())
        }
    }
}()
```

### 5. è¿è¡Œæ•°æ®åº“è¿ç§»

```bash
# ç™»å½•æ•°æ®åº“
mysql -u your_user -p your_database

# æ‰§è¡Œè¿ç§»è„šæœ¬
source bin/migration_add_subscriptions.sql
```

---

## ğŸ¨ å‰ç«¯å®æ–½æ–¹æ¡ˆ

### éœ€è¦åˆ›å»ºçš„é¡µé¢å’Œç»„ä»¶

#### 1. è®¢é˜…å¥—é¤ç®¡ç†é¡µé¢ï¼ˆç®¡ç†å‘˜ï¼‰
**è·¯å¾„**: `web/src/pages/Subscription/index.jsx`
**åŠŸèƒ½**:
- æ˜¾ç¤ºæ‰€æœ‰è®¢é˜…å¥—é¤
- åˆ›å»º/ç¼–è¾‘/åˆ é™¤å¥—é¤
- ä¸ºå¥—é¤ç”Ÿæˆå…‘æ¢ç 

#### 2. ç”¨æˆ·è®¢é˜…é¡µé¢
**è·¯å¾„**: `web/src/pages/MySubscription/index.jsx`
**åŠŸèƒ½**:
- æ˜¾ç¤ºç”¨æˆ·çš„è®¢é˜…ä¿¡æ¯
- æ˜¾ç¤ºé¢åº¦ä½¿ç”¨æƒ…å†µï¼ˆè¿›åº¦æ¡ï¼‰
- æ˜¾ç¤ºåˆ°æœŸæ—¶é—´

#### 3. è®¢é˜…å¥—é¤è¡¨æ ¼ç»„ä»¶
**è·¯å¾„**: `web/src/components/table/subscriptions/SubscriptionsTable.jsx`

#### 4. ä¿®æ”¹å…‘æ¢ç ç»„ä»¶
**è·¯å¾„**: `web/src/components/table/redemptions/RedemptionsColumnDefs.jsx`
**ä¿®æ”¹**: æ·»åŠ ç±»å‹åˆ—ï¼ŒåŒºåˆ†æ™®é€šå……å€¼ç å’Œè®¢é˜…å¥—é¤ç 

---

## ğŸ“ ä½¿ç”¨æµç¨‹

### ç®¡ç†å‘˜æ“ä½œ

1. **åˆ›å»ºè®¢é˜…å¥—é¤**
   ```
   è®¿é—® /subscription
   â†’ ç‚¹å‡»"æ·»åŠ å¥—é¤"
   â†’ å¡«å†™ï¼šåç§°ã€æè¿°ã€æ¯æ—¥/æ¯å‘¨/æ¯æœˆé™é¢ã€å…è®¸åˆ†ç»„ã€æœ‰æ•ˆæœŸ
   â†’ ä¿å­˜
   ```

2. **ç”Ÿæˆå…‘æ¢ç **
   ```
   åœ¨å¥—é¤åˆ—è¡¨ä¸­
   â†’ ç‚¹å‡»"ç”Ÿæˆå…‘æ¢ç "
   â†’ è®¾ç½®ï¼šåç§°ã€æ•°é‡ã€è¿‡æœŸæ—¶é—´
   â†’ ç”Ÿæˆå¹¶å¤åˆ¶å…‘æ¢ç 
   ```

3. **åˆ†å‘å…‘æ¢ç **
   ```
   å°†å…‘æ¢ç åˆ†å‘ç»™ç”¨æˆ·
   ```

### ç”¨æˆ·æ“ä½œ

1. **å…‘æ¢è®¢é˜…**
   ```
   è®¿é—®å……å€¼é¡µé¢
   â†’ è¾“å…¥å…‘æ¢ç 
   â†’ ç‚¹å‡»å…‘æ¢
   â†’ è‡ªåŠ¨æ¿€æ´»è®¢é˜…
   ```

2. **æŸ¥çœ‹è®¢é˜…**
   ```
   è®¿é—® /my-subscription
   â†’ æŸ¥çœ‹è®¢é˜…çŠ¶æ€ã€é¢åº¦ä½¿ç”¨ã€åˆ°æœŸæ—¶é—´
   ```

3. **ä½¿ç”¨è®¢é˜…é¢åº¦**
   ```
   æ­£å¸¸è°ƒç”¨ API
   â†’ ç³»ç»Ÿè‡ªåŠ¨ä¼˜å…ˆä½¿ç”¨è®¢é˜…é¢åº¦
   â†’ è®¢é˜…é¢åº¦ä¸è¶³æ—¶é™çº§åˆ°æ™®é€šé¢åº¦
   ```

---

## ğŸ”„ ç³»ç»Ÿæµç¨‹

### é¢åº¦æ¶ˆè´¹ä¼˜å…ˆçº§

```
API è¯·æ±‚åˆ°è¾¾
  â†“
æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æ¿€æ´»çš„è®¢é˜…
  â†“
æ£€æŸ¥è®¢é˜…æ˜¯å¦æ”¯æŒå½“å‰ä½¿ç”¨çš„åˆ†ç»„
  â†“
æ£€æŸ¥è®¢é˜…é¢åº¦æ˜¯å¦å……è¶³ï¼ˆæ¯æ—¥/æ¯å‘¨/æ¯æœˆï¼‰
  â†“
âœ… æœ‰è®¢é˜…ä¸”é¢åº¦å……è¶³ â†’ ä½¿ç”¨è®¢é˜…é¢åº¦
  â†“
âŒ æ— è®¢é˜…æˆ–é¢åº¦ä¸è¶³ â†’ é™çº§ä½¿ç”¨æ™®é€šå……å€¼é¢åº¦
```

### é¢åº¦é‡ç½®æœºåˆ¶

- **æ¯æ—¥é‡ç½®**: æ¯å¤©å‡Œæ™¨ 0 ç‚¹è‡ªåŠ¨é‡ç½®
- **æ¯å‘¨é‡ç½®**: æ¯å‘¨ä¸€å‡Œæ™¨ 0 ç‚¹è‡ªåŠ¨é‡ç½®
- **æ¯æœˆé‡ç½®**: æ¯æœˆ 1 å·å‡Œæ™¨ 0 ç‚¹è‡ªåŠ¨é‡ç½®
- **è®¢é˜…è¿‡æœŸ**: å®šæ—¶ä»»åŠ¡æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡ï¼Œè‡ªåŠ¨æ ‡è®°è¿‡æœŸè®¢é˜…

---

## âš™ï¸ Redis ç¼“å­˜ç­–ç•¥

### ç¼“å­˜é”®è®¾è®¡

```
user_subscription:{user_id}          # ç”¨æˆ·è®¢é˜…ä¿¡æ¯ï¼Œ30åˆ†é’Ÿè¿‡æœŸ
subscription:{subscription_id}       # å¥—é¤é…ç½®ï¼Œ1å°æ—¶è¿‡æœŸ
subscription_quota:{user_sub_id}     # é¢åº¦ä½¿ç”¨æƒ…å†µï¼Œå®æ—¶æ›´æ–°
```

### ç¼“å­˜æ›´æ–°æ—¶æœº

- **å†™å…¥**: ç”¨æˆ·å…‘æ¢è®¢é˜…æ—¶
- **æ›´æ–°**: æ¶ˆè´¹é¢åº¦æ—¶
- **åˆ é™¤**: è®¢é˜…çŠ¶æ€å˜æ›´æ—¶
- **å¤±æ•ˆ**: è‡ªåŠ¨è¿‡æœŸæˆ–æ‰‹åŠ¨æ¸…é™¤

---

## ğŸ” æµ‹è¯•å»ºè®®

### 1. åŠŸèƒ½æµ‹è¯•

- [ ] åˆ›å»ºè®¢é˜…å¥—é¤
- [ ] ç”Ÿæˆè®¢é˜…å…‘æ¢ç 
- [ ] å…‘æ¢è®¢é˜…ç 
- [ ] ä½¿ç”¨è®¢é˜…é¢åº¦è°ƒç”¨ API
- [ ] æ£€æŸ¥æ¯æ—¥/æ¯å‘¨/æ¯æœˆé¢åº¦é™åˆ¶
- [ ] æµ‹è¯•é¢åº¦é‡ç½®åŠŸèƒ½
- [ ] æµ‹è¯•è®¢é˜…è¿‡æœŸåŠŸèƒ½
- [ ] æµ‹è¯•é¢åº¦ä¸è¶³æ—¶é™çº§åˆ°æ™®é€šé¢åº¦

### 2. è¾¹ç•Œæµ‹è¯•

- [ ] è®¢é˜…é¢åº¦ä¸º 0 æ—¶çš„å¤„ç†
- [ ] åŒæ—¶å­˜åœ¨è®¢é˜…é¢åº¦å’Œæ™®é€šé¢åº¦
- [ ] è®¢é˜…åˆšå¥½åˆ°æœŸæ—¶çš„å¤„ç†
- [ ] å¹¶å‘æ¶ˆè´¹é¢åº¦çš„ä¸€è‡´æ€§

### 3. æ€§èƒ½æµ‹è¯•

- [ ] Redis ç¼“å­˜å‘½ä¸­ç‡
- [ ] é«˜å¹¶å‘ä¸‹çš„é¢åº¦æ¶ˆè´¹
- [ ] æ•°æ®åº“äº‹åŠ¡æ€§èƒ½

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

1. **å¤‡ä»½æ•°æ®åº“**
   ```bash
   mysqldump -u user -p database > backup.sql
   ```

2. **åœæ­¢æœåŠ¡**
   ```bash
   systemctl stop new-api
   ```

3. **æ‹‰å–ä»£ç **
   ```bash
   cd better-new-api
   git pull origin dev
   ```

4. **è¿è¡Œæ•°æ®åº“è¿ç§»**
   ```bash
   mysql -u user -p database < bin/migration_add_subscriptions.sql
   ```

5. **ç¼–è¯‘åç«¯**
   ```bash
   go build -o new-api .
   ```

6. **ç¼–è¯‘å‰ç«¯**ï¼ˆå¦‚æœä¿®æ”¹äº†å‰ç«¯ï¼‰
   ```bash
   cd web
   npm run build
   cd ..
   go build -o new-api .
   ```

7. **å¯åŠ¨æœåŠ¡**
   ```bash
   systemctl start new-api
   ```

8. **éªŒè¯åŠŸèƒ½**
   ```bash
   # æ£€æŸ¥æ—¥å¿—
   tail -f logs/new-api.log

   # æµ‹è¯• API
   curl http://localhost:3000/api/subscriptions
   ```

---

## ğŸ“Š æ•°æ®åº“å…³ç³»å›¾

```
users (ç”¨æˆ·è¡¨)
  â†“ 1:N
user_subscriptions (ç”¨æˆ·è®¢é˜…è¡¨)
  â†“ N:1
subscriptions (è®¢é˜…å¥—é¤è¡¨)

user_subscriptions
  â†“ 1:N
subscription_logs (è®¢é˜…æ—¥å¿—è¡¨)

redemptions (å…‘æ¢ç è¡¨)
  â†“ N:1
subscriptions (è®¢é˜…å¥—é¤è¡¨)
```

---

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

1. **å®Œå…¨éš”ç¦»**: è®¢é˜…é¢åº¦ä¸å……å€¼é¢åº¦å®Œå…¨åˆ†ç¦»
2. **çµæ´»é™é¢**: æ”¯æŒæ¯æ—¥/æ¯å‘¨/æ¯æœˆä¸‰ç§ç»´åº¦
3. **è‡ªåŠ¨é‡ç½®**: å®šæ—¶ä»»åŠ¡è‡ªåŠ¨å¤„ç†è¿‡æœŸå’Œé‡ç½®
4. **Redis ç¼“å­˜**: å‡å°‘æ•°æ®åº“æŸ¥è¯¢ï¼Œæå‡æ€§èƒ½
5. **åŸå­æ“ä½œ**: æ•°æ®åº“äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§
6. **é™çº§æœºåˆ¶**: è®¢é˜…é¢åº¦ä¸è¶³æ—¶è‡ªåŠ¨é™çº§
7. **å…‘æ¢ç é›†æˆ**: å¤ç”¨ç°æœ‰ç³»ç»Ÿï¼Œæ— ç¼å¯¹æ¥
8. **è¯¦ç»†æ—¥å¿—**: è®°å½•æ‰€æœ‰è®¢é˜…é¢åº¦ä½¿ç”¨

---

## ğŸ“š API æ¥å£æ–‡æ¡£

### ç®¡ç†å‘˜æ¥å£

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/api/subscriptions` | GET | è·å–æ‰€æœ‰è®¢é˜…å¥—é¤ |
| `/api/subscriptions/:id` | GET | è·å–å•ä¸ªå¥—é¤è¯¦æƒ… |
| `/api/subscriptions` | POST | åˆ›å»ºè®¢é˜…å¥—é¤ |
| `/api/subscriptions/:id` | PUT | æ›´æ–°è®¢é˜…å¥—é¤ |
| `/api/subscriptions/:id` | DELETE | åˆ é™¤è®¢é˜…å¥—é¤ |
| `/api/subscription-redemptions` | POST | ç”Ÿæˆè®¢é˜…å…‘æ¢ç  |

### ç”¨æˆ·æ¥å£

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/api/user/subscriptions` | GET | è·å–æˆ‘çš„è®¢é˜…åˆ—è¡¨ |
| `/api/user/subscriptions/:id/quota` | GET | è·å–è®¢é˜…é¢åº¦ä½¿ç”¨æƒ…å†µ |
| `/api/user/subscription-logs` | GET | è·å–è®¢é˜…æ—¥å¿— |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“è¿ç§»**: è¯·åœ¨ä½å³°æœŸè¿›è¡Œï¼Œå¹¶æå‰å¤‡ä»½
2. **Redis ä¾èµ–**: å»ºè®®å¯ç”¨ Redis ä»¥è·å¾—æœ€ä½³æ€§èƒ½
3. **æ—¶åŒºè®¾ç½®**: ç¡®ä¿æœåŠ¡å™¨æ—¶åŒºè®¾ç½®æ­£ç¡®ï¼Œå½±å“é‡ç½®æ—¶é—´
4. **å¹¶å‘æ§åˆ¶**: ä½¿ç”¨äº†æ•°æ®åº“è¡Œé”ï¼Œé«˜å¹¶å‘åœºæ™¯éœ€è¦å…³æ³¨æ€§èƒ½
5. **å…‘æ¢ç å®‰å…¨**: è®¢é˜…å…‘æ¢ç ä¸€æ¬¡æ€§ä½¿ç”¨ï¼Œè¯·å¦¥å–„ä¿ç®¡

---

## ğŸ› å·²çŸ¥é—®é¢˜å’Œæ”¹è¿›å»ºè®®

### å·²çŸ¥é™åˆ¶
- ç”¨æˆ·åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªæ¿€æ´»çš„è®¢é˜…
- è®¢é˜…ä¸æ”¯æŒç»­è´¹ï¼Œéœ€è¦é‡æ–°å…‘æ¢

### æœªæ¥æ”¹è¿›æ–¹å‘
- æ”¯æŒè‡ªåŠ¨ç»­è´¹åŠŸèƒ½
- æ”¯æŒå¤šä¸ªè®¢é˜…åŒæ—¶æ¿€æ´»
- æ”¯æŒè®¢é˜…å‡çº§/é™çº§
- æ·»åŠ è®¢é˜…ä½¿ç”¨ç»Ÿè®¡å›¾è¡¨
- æ”¯æŒæŒ‰æ¨¡å‹é™é¢

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
1. æ—¥å¿—æ–‡ä»¶ï¼š`logs/new-api.log`
2. æ•°æ®åº“æ—¥å¿—ï¼šæ£€æŸ¥ subscription_logs è¡¨
3. Redis ç¼“å­˜çŠ¶æ€ï¼š`redis-cli keys "user_subscription:*"`

å®Œæˆå®æ–½ï¼ğŸ‰
