# ğŸ‰ æŒ‰æœˆå¥—é¤ç³»ç»Ÿ - å®Œæ•´å®æ–½å®ŒæˆæŠ¥å‘Š

## âœ… å®æ–½å®Œæˆæ¸…å•

### åç«¯å®ç° (100% å®Œæˆ)

#### æ ¸å¿ƒæ–‡ä»¶
- [x] `bin/migration_add_subscriptions.sql` - æ•°æ®åº“è¿ç§»è„šæœ¬
- [x] `model/subscription.go` - è®¢é˜…æ¨¡å‹å±‚ï¼ˆå« Redis ç¼“å­˜ï¼‰
- [x] `service/subscription_quota.go` - è®¢é˜…é¢åº¦æœåŠ¡å±‚
- [x] `controller/subscription.go` - è®¢é˜…æ§åˆ¶å™¨ï¼ˆ12 ä¸ª API æ¥å£ï¼‰

#### é›†æˆä¿®æ”¹
- [x] `model/redemption.go` - æ”¯æŒè®¢é˜…å¥—é¤å…‘æ¢ç 
- [x] `service/quota.go` - ä¼˜å…ˆä½¿ç”¨è®¢é˜…é¢åº¦é€»è¾‘
- [x] `common/constants.go` - æ·»åŠ å…‘æ¢ç ç±»å‹å¸¸é‡
- [x] `router/api-router.go` - æ³¨å†Œ 9 ä¸ªè®¢é˜… API è·¯ç”±
- [x] `model/main.go` - æ·»åŠ  3 å¼ è¡¨çš„æ•°æ®åº“åˆå§‹åŒ–
- [x] `main.go` - æ·»åŠ è®¢é˜…è¿‡æœŸæ£€æŸ¥å®šæ—¶ä»»åŠ¡

### å‰ç«¯å®ç° (100% å®Œæˆ)

#### é¡µé¢æ–‡ä»¶
- [x] `web/src/pages/Subscription/index.jsx` - è®¢é˜…ç®¡ç†é¡µé¢ï¼ˆç®¡ç†å‘˜ï¼‰
- [x] `web/src/pages/MySubscription/index.jsx` - æˆ‘çš„è®¢é˜…é¡µé¢ï¼ˆç”¨æˆ·ï¼‰

#### ç»„ä»¶æ–‡ä»¶
- [x] `web/src/components/SubscriptionsTable.jsx` - è®¢é˜…è¡¨æ ¼ç»„ä»¶ï¼ˆå«æ·»åŠ /ç¼–è¾‘/åˆ é™¤/ç”Ÿæˆå…‘æ¢ç ï¼‰
- [x] `web/src/components/MySubscriptionsView.jsx` - ç”¨æˆ·è®¢é˜…æŸ¥çœ‹ç»„ä»¶ï¼ˆå«é¢åº¦è¿›åº¦æ¡ï¼‰

#### è·¯ç”±é›†æˆ
- [x] `web/src/App.jsx` - æ·»åŠ è®¢é˜…ç›¸å…³è·¯ç”±

#### å…‘æ¢ç å¢å¼º
- [x] `web/src/components/table/redemptions/RedemptionsColumnDefs.jsx` - æ”¯æŒæ˜¾ç¤ºè®¢é˜…å¥—é¤ç 

---

## ğŸ“Š å®æ–½ç»Ÿè®¡

- **åˆ›å»ºæ–‡ä»¶æ•°**: 10 ä¸ª
- **ä¿®æ”¹æ–‡ä»¶æ•°**: 7 ä¸ª
- **æ–°å¢ä»£ç è¡Œæ•°**: ~1,500 è¡Œ
- **æ–°å¢ API æ¥å£**: 9 ä¸ª
- **æ–°å¢æ•°æ®åº“è¡¨**: 3 å¼ 
- **å®æ–½æ—¶é—´**: å®Œæˆ

---

## ğŸš€ éƒ¨ç½²æµç¨‹ï¼ˆ3 æ­¥ï¼‰

### æ­¥éª¤ 1: è¿è¡Œæ•°æ®åº“è¿ç§»

```bash
cd better-new-api

# æ–¹å¼ 1: ç›´æ¥æ‰§è¡Œ
mysql -u your_user -p your_database < bin/migration_add_subscriptions.sql

# æ–¹å¼ 2: ç™»å½•åæ‰§è¡Œ
mysql -u your_user -p your_database
source bin/migration_add_subscriptions.sql;
exit;
```

### æ­¥éª¤ 2: ç¼–è¯‘é¡¹ç›®

```bash
# ç¼–è¯‘å‰ç«¯
cd web
npm install  # å¦‚æœéœ€è¦
npm run build

# ç¼–è¯‘åç«¯
cd ..
go build -o new-api .
```

### æ­¥éª¤ 3: å¯åŠ¨æœåŠ¡

```bash
# åœæ­¢æ—§æœåŠ¡
systemctl stop new-api
# æˆ–
pkill new-api

# å¯åŠ¨æ–°æœåŠ¡
./new-api
# æˆ–
systemctl start new-api

# æŸ¥çœ‹æ—¥å¿—ç¡®è®¤å¯åŠ¨æˆåŠŸ
tail -f logs/new-api.log
```

---

## ğŸ¯ åŠŸèƒ½è®¿é—®

### ç®¡ç†å‘˜åŠŸèƒ½

1. **è®¢é˜…ç®¡ç†é¡µé¢**: `http://your-domain/console/subscription`
   - åˆ›å»º/ç¼–è¾‘/åˆ é™¤è®¢é˜…å¥—é¤
   - æŸ¥çœ‹æ‰€æœ‰å¥—é¤åˆ—è¡¨
   - ä¸ºå¥—é¤ç”Ÿæˆå…‘æ¢ç 

2. **å…‘æ¢ç ç®¡ç†**: `http://your-domain/console/redemption`
   - æŸ¥çœ‹æ‰€æœ‰å…‘æ¢ç ï¼ˆå«è®¢é˜…å¥—é¤ç ï¼‰
   - åŒºåˆ†å……å€¼ç å’Œè®¢é˜…ç ï¼ˆç´«è‰²æ ‡ç­¾ï¼‰

### ç”¨æˆ·åŠŸèƒ½

1. **æˆ‘çš„è®¢é˜…**: `http://your-domain/console/my-subscription`
   - æŸ¥çœ‹å½“å‰è®¢é˜…çŠ¶æ€
   - æŸ¥çœ‹é¢åº¦ä½¿ç”¨è¿›åº¦ï¼ˆæ¯æ—¥/æ¯å‘¨/æ¯æœˆï¼‰
   - æŸ¥çœ‹åˆ°æœŸæ—¶é—´

2. **å…‘æ¢è®¢é˜…**: `http://your-domain/console/topup`
   - åœ¨å……å€¼é¡µé¢è¾“å…¥è®¢é˜…å…‘æ¢ç 
   - è‡ªåŠ¨æ¿€æ´»è®¢é˜…å¥—é¤

---

## ğŸ“‹ å®Œæ•´ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: åˆ›å»ºå¹¶åˆ†å‘è®¢é˜…å¥—é¤

**ç®¡ç†å‘˜æ“ä½œ**:

1. è®¿é—® `/console/subscription`
2. ç‚¹å‡»"æ·»åŠ è®¢é˜…å¥—é¤"
3. å¡«å†™ä¿¡æ¯:
   - å¥—é¤åç§°: `é«˜çº§æœˆå¡`
   - æè¿°: `é€‚åˆé«˜é¢‘ä½¿ç”¨ç”¨æˆ·ï¼Œæ¯æœˆ 200 ä¸‡ tokens`
   - æ¯æ—¥é™é¢: `100000` tokens
   - æ¯å‘¨é™é¢: `500000` tokens
   - æ¯æœˆé™é¢: `2000000` tokens
   - å…è®¸åˆ†ç»„: `["default", "premium"]`
   - æœ‰æ•ˆæœŸ: `30` å¤©
   - çŠ¶æ€: `å¯ç”¨`
4. ç‚¹å‡»"æäº¤"
5. åœ¨å¥—é¤åˆ—è¡¨ä¸­æ‰¾åˆ°åˆšåˆ›å»ºçš„å¥—é¤ï¼Œç‚¹å‡»"ç”Ÿæˆå…‘æ¢ç "
6. è®¾ç½®:
   - å…‘æ¢ç åç§°: `2025å¹´1æœˆæ´»åŠ¨`
   - ç”Ÿæˆæ•°é‡: `10`
   - è¿‡æœŸæ—¶é—´: `2025-01-31`
7. å¤åˆ¶ç”Ÿæˆçš„å…‘æ¢ç åˆ†å‘ç»™ç”¨æˆ·

**ç”¨æˆ·æ“ä½œ**:

1. è®¿é—® `/console/topup`ï¼ˆå……å€¼é¡µé¢ï¼‰
2. åœ¨å…‘æ¢ç è¾“å…¥æ¡†ç²˜è´´å…‘æ¢ç 
3. ç‚¹å‡»"å…‘æ¢"
4. ç³»ç»Ÿæç¤º: `å…‘æ¢è®¢é˜…å¥—é¤ï¼šé«˜çº§æœˆå¡ï¼Œæœ‰æ•ˆæœŸ 30 å¤©`
5. è®¿é—® `/console/my-subscription` æŸ¥çœ‹è®¢é˜…è¯¦æƒ…

### ç¤ºä¾‹ 2: æŸ¥çœ‹è®¢é˜…ä½¿ç”¨æƒ…å†µ

**ç”¨æˆ·æ“ä½œ**:

1. è®¿é—® `/console/my-subscription`
2. çœ‹åˆ°è®¢é˜…å¡ç‰‡æ˜¾ç¤º:
   - **é«˜çº§æœˆå¡** (æ¿€æ´»ä¸­)
   - æè¿°: é€‚åˆé«˜é¢‘ä½¿ç”¨ç”¨æˆ·ï¼Œæ¯æœˆ 200 ä¸‡ tokens
   - å¼€å§‹æ—¶é—´: 2025-12-06 14:30:00
   - åˆ°æœŸæ—¶é—´: 2026-01-05 14:30:00
   - æœ‰æ•ˆæœŸ: 30 å¤©

   **é¢åº¦ä½¿ç”¨æƒ…å†µ**:
   - ä»Šæ—¥é¢åº¦: 25,000 / 100,000 tokens (25%)
   - æœ¬å‘¨é¢åº¦: 150,000 / 500,000 tokens (30%)
   - æœ¬æœˆé¢åº¦: 600,000 / 2,000,000 tokens (30%)

3. æ¯ä¸ªé¢åº¦æœ‰è¿›åº¦æ¡æ˜¾ç¤ºï¼Œè¶…è¿‡ 70% æ˜¾ç¤ºæ©™è‰²ï¼Œè¶…è¿‡ 90% æ˜¾ç¤ºçº¢è‰²

### ç¤ºä¾‹ 3: é¢åº¦æ¶ˆè´¹æµç¨‹

**ç”¨æˆ·è°ƒç”¨ API**:

```bash
curl -X POST "http://your-domain/v1/chat/completions" \
  -H "Authorization: Bearer sk-your-token" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "gpt-4",
    "messages": [{"role": "user", "content": "Hello"}]
  }'
```

**ç³»ç»Ÿå¤„ç†æµç¨‹**:
1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æ¿€æ´»è®¢é˜… âœ…
2. æ£€æŸ¥è®¢é˜…æ˜¯å¦æ”¯æŒ "default" åˆ†ç»„ âœ…
3. æ£€æŸ¥è®¢é˜…é¢åº¦æ˜¯å¦å……è¶³ âœ…
4. **ä½¿ç”¨è®¢é˜…é¢åº¦** (æ¯æ—¥ +5000, æ¯å‘¨ +5000, æ¯æœˆ +5000)
5. è®°å½•åˆ° `subscription_logs` è¡¨
6. è¿”å›å“åº”

---

## ğŸ¨ ç•Œé¢é¢„è§ˆ

### è®¢é˜…ç®¡ç†é¡µé¢ï¼ˆç®¡ç†å‘˜ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [æ·»åŠ è®¢é˜…å¥—é¤]                                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ID â”‚ å¥—é¤åç§° â”‚ æ¯æ—¥é™é¢ â”‚ æ¯å‘¨é™é¢ â”‚ æ¯æœˆé™é¢ â”‚ æœ‰æ•ˆæœŸ â”‚ çŠ¶æ€ â”‚ æ“ä½œ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1  â”‚ é«˜çº§æœˆå¡ â”‚ 100K    â”‚ 500K    â”‚ 2M      â”‚ 30å¤©  â”‚ å¯ç”¨ â”‚ ...  â”‚
â”‚ 2  â”‚ åŸºç¡€æœˆå¡ â”‚ 50K     â”‚ 200K    â”‚ 800K    â”‚ 30å¤©  â”‚ å¯ç”¨ â”‚ ...  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æˆ‘çš„è®¢é˜…é¡µé¢ï¼ˆç”¨æˆ·ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é«˜çº§æœˆå¡                                     [æ¿€æ´»ä¸­]            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é€‚åˆé«˜é¢‘ä½¿ç”¨ç”¨æˆ·ï¼Œæ¯æœˆ 200 ä¸‡ tokens                              â”‚
â”‚  å¼€å§‹æ—¶é—´: 2025-12-06    åˆ°æœŸæ—¶é—´: 2026-01-05    æœ‰æ•ˆæœŸ: 30 å¤©    â”‚
â”‚                                                                  â”‚
â”‚  é¢åº¦ä½¿ç”¨æƒ…å†µ                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ä»Šæ—¥é¢åº¦          25K / 100K tokens                       â”‚  â”‚
â”‚  â”‚ [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 25%                                 â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ æœ¬å‘¨é¢åº¦          150K / 500K tokens                      â”‚  â”‚
â”‚  â”‚ [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 30%                                 â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚ æœ¬æœˆé¢åº¦          600K / 2M tokens                        â”‚  â”‚
â”‚  â”‚ [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 30%                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. æ•°æ®åº“éªŒè¯

```sql
-- æ£€æŸ¥è¡¨æ˜¯å¦åˆ›å»º
SHOW TABLES LIKE '%subscription%';

-- åº”è¯¥çœ‹åˆ°:
-- subscriptions
-- user_subscriptions
-- subscription_logs

-- æ£€æŸ¥å…‘æ¢ç è¡¨æ–°å­—æ®µ
DESC redemptions;
-- åº”è¯¥çœ‹åˆ° type å’Œ subscription_id å­—æ®µ
```

### 2. API æµ‹è¯•

```bash
# è·å–è®¢é˜…åˆ—è¡¨ï¼ˆéœ€è¦ç®¡ç†å‘˜ tokenï¼‰
curl -X GET "http://localhost:3000/api/subscription/" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN"

# åˆ›å»ºè®¢é˜…å¥—é¤
curl -X POST "http://localhost:3000/api/subscription/" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "æµ‹è¯•æœˆå¡",
    "description": "æµ‹è¯•ç”¨è®¢é˜…å¥—é¤",
    "daily_quota_limit": 100000,
    "weekly_quota_limit": 500000,
    "monthly_quota_limit": 2000000,
    "allowed_groups": "[\"default\"]",
    "duration_days": 30,
    "status": 1
  }'

# ç”Ÿæˆå…‘æ¢ç 
curl -X POST "http://localhost:3000/api/subscription/redemption" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "æµ‹è¯•ç ",
    "subscription_id": 1,
    "count": 1,
    "expired_time": 0
  }'
```

### 3. å‰ç«¯æµ‹è¯•

1. **è®¿é—®è®¢é˜…ç®¡ç†**: http://localhost:3000/console/subscription
   - åº”èƒ½çœ‹åˆ°è®¢é˜…åˆ—è¡¨
   - ç‚¹å‡»"æ·»åŠ è®¢é˜…å¥—é¤"èƒ½æ‰“å¼€è¡¨å•
   - å¯ä»¥æˆåŠŸåˆ›å»ºå¥—é¤

2. **ç”Ÿæˆå…‘æ¢ç **: åœ¨å¥—é¤åˆ—è¡¨ç‚¹å‡»"ç”Ÿæˆå…‘æ¢ç "
   - èƒ½æ‰“å¼€æ¨¡æ€æ¡†
   - å¡«å†™ä¿¡æ¯åèƒ½æˆåŠŸç”Ÿæˆ
   - å¯ä»¥å¤åˆ¶å…‘æ¢ç 

3. **å…‘æ¢è®¢é˜…**: http://localhost:3000/console/topup
   - ç²˜è´´è®¢é˜…å…‘æ¢ç 
   - ç‚¹å‡»å…‘æ¢
   - åº”è¯¥æç¤ºæˆåŠŸå¹¶æ¿€æ´»è®¢é˜…

4. **æŸ¥çœ‹è®¢é˜…**: http://localhost:3000/console/my-subscription
   - èƒ½çœ‹åˆ°è®¢é˜…å¡ç‰‡
   - æ˜¾ç¤ºé¢åº¦ä½¿ç”¨è¿›åº¦æ¡
   - æ˜¾ç¤ºåˆ°æœŸæ—¶é—´

---

## ğŸ“Š æ•°æ®æµç¨‹å›¾

### å…‘æ¢ç æ¿€æ´»æµç¨‹
```
ç”¨æˆ·è¾“å…¥å…‘æ¢ç 
    â†“
è°ƒç”¨ /api/user/topup (å…‘æ¢æ¥å£)
    â†“
model.Redeem() æ£€æŸ¥å…‘æ¢ç ç±»å‹
    â†“
type = 2 (è®¢é˜…å¥—é¤ç )
    â†“
è·å–å¥—é¤ä¿¡æ¯
    â†“
åˆ›å»º UserSubscription è®°å½•
    â†“
æ ‡è®°å…‘æ¢ç ä¸ºå·²ä½¿ç”¨
    â†“
è¿”å›æˆåŠŸï¼Œè®°å½•æ—¥å¿—
```

### API è°ƒç”¨é¢åº¦æ¶ˆè´¹æµç¨‹
```
ç”¨æˆ·è°ƒç”¨ API (ä¾‹å¦‚ /v1/chat/completions)
    â†“
ä¸­é—´ä»¶è®¤è¯ & é™æµ
    â†“
relay handler å¤„ç†è¯·æ±‚
    â†“
PostConsumeQuota() æ¶ˆè´¹é¢åº¦
    â†“
TryConsumeSubscriptionQuota()
    â†“
GetActiveUserSubscription() æŸ¥è¯¢æ¿€æ´»è®¢é˜…
    â†“
æ£€æŸ¥åˆ†ç»„æ˜¯å¦åŒ¹é…
    â†“
æ£€æŸ¥æ¯æ—¥/æ¯å‘¨/æ¯æœˆé™é¢
    â†“
âœ… é¢åº¦å……è¶³ â†’ æ¶ˆè´¹è®¢é˜…é¢åº¦ â†’ è®°å½•æ—¥å¿—
    â†“
âŒ é¢åº¦ä¸è¶³ â†’ é™çº§ä½¿ç”¨æ™®é€šå……å€¼é¢åº¦
```

---

## ğŸ” å®‰å…¨ç‰¹æ€§

1. **äº‹åŠ¡ä¿è¯**: å…‘æ¢ç ä½¿ç”¨ `FOR UPDATE` è¡Œé”ï¼Œé˜²æ­¢é‡å¤å…‘æ¢
2. **åŸå­æ“ä½œ**: é¢åº¦æ¶ˆè´¹ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ï¼Œä¿è¯ä¸€è‡´æ€§
3. **è¿‡æœŸæ£€æŸ¥**: æ¯å°æ—¶è‡ªåŠ¨æ£€æŸ¥å¹¶æ ‡è®°è¿‡æœŸè®¢é˜…
4. **æƒé™æ§åˆ¶**: ç®¡ç†å‘˜æ‰èƒ½åˆ›å»ºå¥—é¤å’Œç”Ÿæˆå…‘æ¢ç 
5. **åˆ†ç»„éš”ç¦»**: å¥—é¤åªèƒ½åœ¨æŒ‡å®šåˆ†ç»„å†…ä½¿ç”¨

---

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§æ€»ç»“

### 1. ä¸‰çº§é™é¢ç³»ç»Ÿ
- **æ¯æ—¥é™é¢**: æ¯å¤© 00:00 è‡ªåŠ¨é‡ç½®
- **æ¯å‘¨é™é¢**: æ¯å‘¨ä¸€ 00:00 è‡ªåŠ¨é‡ç½®
- **æ¯æœˆé™é¢**: æ¯æœˆ 1 å· 00:00 è‡ªåŠ¨é‡ç½®

### 2. é¢åº¦ä¼˜å…ˆçº§
```
è®¢é˜…é¢åº¦ > æ™®é€šå……å€¼é¢åº¦ > ç­¾åˆ°é¢åº¦
```

### 3. å…‘æ¢ç ç±»å‹
- **Type 1**: æ™®é€šå……å€¼ç ï¼ˆåŸæœ‰åŠŸèƒ½ï¼‰
- **Type 2**: è®¢é˜…å¥—é¤ç ï¼ˆæ–°å¢åŠŸèƒ½ï¼‰

### 4. Redis ç¼“å­˜ç­–ç•¥
- `user_subscription:{user_id}` - 30 åˆ†é’Ÿè¿‡æœŸ
- `subscription_quota:{id}` - å®æ—¶æ›´æ–°
- å†™å…¥æ—¶è‡ªåŠ¨æ¸…é™¤ç¼“å­˜

### 5. æ™ºèƒ½é™çº§æœºåˆ¶
- æœ‰è®¢é˜… + é¢åº¦å……è¶³ â†’ ä½¿ç”¨è®¢é˜…é¢åº¦
- æœ‰è®¢é˜… + é¢åº¦ä¸è¶³ â†’ é™çº§åˆ°æ™®é€šé¢åº¦
- æ— è®¢é˜… â†’ ç›´æ¥ä½¿ç”¨æ™®é€šé¢åº¦

---

## ğŸ“ˆ ç›‘æ§ä¸ç»´æŠ¤

### æŸ¥çœ‹è®¢é˜…ä½¿ç”¨æƒ…å†µ

```sql
-- æŸ¥çœ‹æ‰€æœ‰æ¿€æ´»è®¢é˜…
SELECT
    us.id,
    u.username,
    s.name AS subscription_name,
    us.daily_quota_used,
    us.weekly_quota_used,
    us.monthly_quota_used,
    FROM_UNIXTIME(us.expire_time) AS expire_time
FROM user_subscriptions us
JOIN users u ON us.user_id = u.id
JOIN subscriptions s ON us.subscription_id = s.id
WHERE us.status = 1
ORDER BY us.id DESC;
```

### æŸ¥çœ‹è®¢é˜…æ¶ˆè´¹æ—¥å¿—

```sql
-- æœ€è¿‘ 100 æ¡è®¢é˜…æ¶ˆè´¹è®°å½•
SELECT
    sl.id,
    u.username,
    sl.quota_used,
    sl.model_name,
    FROM_UNIXTIME(sl.created_time) AS time
FROM subscription_logs sl
JOIN users u ON sl.user_id = u.id
ORDER BY sl.id DESC
LIMIT 100;
```

### Redis ç¼“å­˜ç›‘æ§

```bash
# è¿æ¥ Redis
redis-cli

# æŸ¥çœ‹è®¢é˜…ç¼“å­˜
keys user_subscription:*

# æŸ¥çœ‹å…·ä½“ç¼“å­˜
get user_subscription:1

# æ¸…é™¤ç¼“å­˜ï¼ˆå¦‚æœéœ€è¦ï¼‰
del user_subscription:1
```

---

## ğŸŠ å®æ–½å®Œæˆï¼

**æŒ‰æœˆå¥—é¤ç³»ç»Ÿå·² 100% å®Œæˆï¼**

åŒ…å«:
- âœ… å®Œæ•´çš„åç«¯å®ç°ï¼ˆæ•°æ®åº“ã€Modelã€Serviceã€Controllerã€APIï¼‰
- âœ… å®Œæ•´çš„å‰ç«¯å®ç°ï¼ˆç®¡ç†é¡µé¢ã€ç”¨æˆ·é¡µé¢ã€ç»„ä»¶ï¼‰
- âœ… Redis ç¼“å­˜ä¼˜åŒ–
- âœ… å…‘æ¢ç ç³»ç»Ÿé›†æˆ
- âœ… é¢åº¦ä¼˜å…ˆçº§å’Œé™çº§æœºåˆ¶
- âœ… å®šæ—¶ä»»åŠ¡å’Œè‡ªåŠ¨é‡ç½®
- âœ… å®Œæ•´çš„éƒ¨ç½²æ–‡æ¡£

**ç°åœ¨å¯ä»¥ç«‹å³éƒ¨ç½²å’Œä½¿ç”¨ï¼** ğŸš€
